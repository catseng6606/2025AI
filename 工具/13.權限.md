# 資料庫安全三部曲

1. 建立 Web 專屬低權限帳號

``` sql
-- 建立使用者
CREATE USER 'webuser'@'localhost' IDENTIFIED BY 'YourStrongPassword123!';
CREATE USER 'webuser'@'172.18.%' IDENTIFIED BY 'YourStrongPassword123!';
-- 確保它對所有資料表「零權限」（預設建立時即為零權限，但可透過此確認）
REVOKE ALL PRIVILEGES, GRANT OPTION FROM 'webuser'@'localhost';

-- 加入`課程表`的 select 權限
GRANT SELECT ON my_database.課程表 TO 'webuser'@'localhost';
REVOKE SELECT ON my_database.課程表 FROM 'webuser'@'localhost';
FLUSH PRIVILEGES;

-- 1. 刪除從本機連線的帳號
DROP USER IF EXISTS 'webuser'@'localhost';

-- 2. 刪除從 172.18.*.* 網段連線的帳號
DROP USER IF EXISTS 'webuser'@'172.18.%';

-- 3. 刪除（選用）如果你之前有建立過任何 IP (%) 的帳號
DROP USER IF EXISTS 'webuser'@'%';

-- 4. 確保變更立即生效
FLUSH PRIVILEGES;
```

2. 建立 SP

``` sql
DELIMITER //

-- A. 新增課程的 SP (包含 Log 紀錄)
CREATE PROCEDURE sp_新增課程(
    IN p_課程編號 VARCHAR(10),
    IN p_課程名稱 VARCHAR(50),
    IN p_學分 INT
)
BEGIN
    -- 1. 執行核心 CRUD 邏輯
    INSERT INTO 課程表 (課程編號, 課程名稱, 學分) 
    VALUES (p_課程編號, p_課程名稱, p_學分);
    
    -- 2. 自動寫入 Log (符合安全三部曲要求)
    INSERT INTO 操作日誌 (操作類型, 操作內容) 
    VALUES ('INSERT', CONCAT('新增課程：', p_課程編號, ' (', p_課程名稱, ')'));
END //

-- B. 查詢課程的 SP (隱藏資料表結構細節)
CREATE PROCEDURE sp_查詢課程(
    IN p_課程編號 VARCHAR(10)
)
BEGIN
    -- 透過 SP 回傳結果，Web 端不需要知道表名
    SELECT 課程編號, 課程名稱, 學分 
    FROM 課程表 
    WHERE 課程編號 = p_課程編號;
    
    -- 可選擇性紀錄查詢 Log
    INSERT INTO 操作日誌 (操作類型, 操作內容) 
    VALUES ('SELECT', CONCAT('查詢課程：', p_課程編號));
END //

DELIMITER ;
```

3. 加入權限

``` sql
-- 1. 確保 webuser 只有連線權限，對「課程表」與「操作日誌」零權限
-- (假設你已經建立好 webuser)

-- 2. 僅授予 SP 的 EXECUTE 執行權
GRANT EXECUTE ON PROCEDURE my_database.sp_新增課程 TO 'webuser'@'localhost';
GRANT EXECUTE ON PROCEDURE my_database.sp_查詢課程 TO 'webuser'@'localhost';

-- 3. 刷新權限
FLUSH PRIVILEGES;
```

4. 使用

``` sql
-- Web 端改用此方式新增資料
CALL sp_新增課程('C002', '程式設計', 3);

-- Web 端改用此方式查詢資料
CALL sp_查詢課程('C002');
```

5. 操作日誌

``` sql
-- 更新後的操作日誌表
CREATE TABLE 操作日誌 (
    日誌編號 INT AUTO_INCREMENT PRIMARY KEY,
    執行命令名稱 VARCHAR(100) NOT NULL,
    輸入參數JSON JSON,                  -- 新增：紀錄 Web 端傳入的原始參數
    執行前資料JSON JSON,
    執行後資料JSON JSON,
    操作者 VARCHAR(50),
    執行時間 DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

``` sql
DELIMITER //

CREATE PROCEDURE sp_紀錄日誌(
    IN p_命令名稱 VARCHAR(100),
    IN p_輸入參數 JSON,         -- 新增參數
    IN p_前資料 JSON,
    IN p_後資料 JSON
)
BEGIN
    INSERT INTO 操作日誌 (執行命令名稱, 輸入參數JSON, 執行前資料JSON, 執行後資料JSON, 操作者)
    VALUES (p_命令名稱, p_輸入參數, p_前資料, p_後資料, CURRENT_USER());
END //

DELIMITER ;
```

6. 使用範例：以「修改課程」為例

``` sql
DELIMITER //

CREATE PROCEDURE sp_修改課程_完整審計(
    IN p_課程編號 VARCHAR(10),
    IN p_新課程名稱 VARCHAR(50),
    IN p_新學分 INT
)
BEGIN
    -- 定義變數來暫存執行前與執行後的資料
    DECLARE v_old_data JSON;
    DECLARE v_new_data JSON;
    DECLARE v_params JSON;

    -- 1. 封裝輸入參數
    SET v_params = JSON_OBJECT('課程編號', p_課程編號, '新課程名稱', p_新課程名稱, '新學分', p_新學分);

    -- 2. 取得執行前的原始資料 (隱藏細節：Web 端不需要知道怎麼 SELECT)
    SELECT JSON_OBJECT('課程編號', 課程編號, '課程名稱', 課程名稱, '學分', 學分) 
    INTO v_old_data
    FROM 課程表 WHERE 課程編號 = p_課程編號;

    -- 3. 執行更新動作
    UPDATE 課程表 
    SET 課程名稱 = p_新課程名稱, 學分 = p_新學分
    WHERE 課程編號 = p_課程編號;

    -- 4. 取得執行後的最新資料
    SELECT JSON_OBJECT('課程編號', 課程編號, '課程名稱', 課程名稱, '學分', 學分) 
    INTO v_new_data
    FROM 課程表 WHERE 課程編號 = p_課程編號;

    -- 5. 呼叫日誌 SP，紀錄完整三部曲
    CALL sp_紀錄日誌('sp_修改課程_完整審計', v_params, v_old_data, v_new_data);
    
END //

DELIMITER ;

```